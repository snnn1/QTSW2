# Why NQ2 Slot Time Changed: 09:30 â†’ 11:00

## Timeline

1. **Stream Initialized**: 2026-02-02T07:54:03 CT (13:54:03 UTC)
   - Slot time at initialization: **09:30**
   - Source: Timetable file at that time

2. **Timetable Regenerated**: 2026-02-02T15:46:48 CT (21:46:48 UTC)
   - Slot time in new timetable: **11:00**
   - Source: `data/timetable/timetable_current.json` shows `as_of: "2026-02-02T15:46:48.396395-06:00"`

3. **Time Difference**: ~8 hours after stream initialization

## Root Cause: Timetable Engine RS-Based Time Selection

The timetable is generated by `timetable_engine.py` which uses **RS (Relative Strength) calculation** to select the best time slot for each stream.

### How RS Calculation Works

1. **Looks at last 13 trades** per time slot (configurable via `lookback_days`)
2. **Scores each trade**:
   - WIN = +1
   - LOSS = -2
   - BE/TIME/NO TRADE = 0
3. **Sums scores** for each time slot
4. **Selects time slot with highest RS value**

### Why NQ2 Changed from 09:30 to 11:00

The timetable engine's `select_best_time()` method calculated RS values for NQ2 S2 session:
- **09:30 time slot**: Lower RS value (based on recent trade results)
- **11:00 time slot**: Higher RS value (better recent performance)

When the timetable was regenerated at 15:46:48 CT, the engine:
1. Calculated RS for all S2 time slots (09:30, 10:00, 10:30, 11:00)
2. Found that 11:00 had the highest RS
3. Selected 11:00 as the best time slot
4. Updated the timetable file

### Why This Happened Mid-Session

The timetable can be regenerated:
- **Manually**: By running the timetable generation script
- **Automatically**: By the dashboard/matrix app when master matrix is rebuilt
- **Scheduled**: If there's a scheduled task that regenerates it

When the timetable is regenerated, it recalculates RS values based on the **latest master matrix data**, which may include new trade results that change the RS rankings.

## The Problem

**Stream was already initialized** with slot_time 09:30 when the timetable was updated to 11:00. This created a mismatch:
- Stream's internal state: `slot_time_chicago: "09:30"`
- Timetable file: `slot_time: "11:00"`

This mismatch caused confusion and prevented the stream from reaching its intended slot_time (11:00) because it was still using 09:30.

## The Fix Applied

I've added protection in `StreamStateMachine.ApplyDirectiveUpdate()` to **prevent slot_time changes after PRE_HYDRATION state**. This ensures:
- Streams initialized with a slot_time keep that slot_time for the entire trading day
- Timetable updates don't affect already-initialized streams
- Slot_time consistency throughout the stream lifecycle

## How to Verify Why 11:00 Was Selected

To understand why 11:00 was selected over 09:30, check:

1. **Master Matrix Data**: Look at recent NQ2 S2 trades
   - How many WIN/LOSS/BE at 09:30 vs 11:00?
   - What are the RS values for each time slot?

2. **RS Calculation**: The timetable engine calculates RS as:
   ```python
   RS = sum(scores for last 13 trades)
   where WIN=+1, LOSS=-2, BE/TIME/NO_TRADE=0
   ```

3. **Time Slot Selection**: The engine selects the time slot with **highest RS**

## Prevention

The fix I applied prevents this from happening again:
- Streams lock their slot_time at initialization
- Timetable updates are rejected if stream is past PRE_HYDRATION
- Warning is logged when update is rejected
- Critical alert is sent for visibility

## Questions to Investigate

1. **Why was the timetable regenerated at 15:46:48 CT?**
   - Was it manual?
   - Was it automatic (dashboard/matrix app)?
   - Was master matrix rebuilt?

2. **What were the actual RS values?**
   - RS for 09:30: ?
   - RS for 11:00: ?
   - What recent trades caused 11:00 to have higher RS?

3. **Should timetable updates be allowed mid-session?**
   - Current fix: NO (prevents mid-session changes)
   - Alternative: Allow updates but only for streams not yet initialized
